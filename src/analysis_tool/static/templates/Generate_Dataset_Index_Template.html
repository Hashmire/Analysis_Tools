<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Tools - Generate Dataset Session Report</title>
    
    <link rel="stylesheet" href="css/generate_dataset_dashboard.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Generate Dataset Session Report</h1>
            <p>NVD Source Processing Summary<br />
            Hashmire/Analysis_Tools {{TOOL_VERSION}}</p>
        </div>

        <div class="content">
            <!-- Session Information -->
            <div class="session-info">
                <h3>Session Information</h3>
                <p><strong>Run ID:</strong> <span id="run-id">--</span></p>
                <p><strong>Started:</strong> <span id="session-start">--</span></p>
                <p><strong>Completed:</strong> <span id="session-end">--</span></p>
                <p><strong>Duration:</strong> <span id="session-duration">--</span></p>
                <p><strong>Status:</strong> <span id="session-status">--</span></p>
            </div>

            <!-- Summary Statistics -->
            <div class="section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Processing Summary</h2>
                        <p class="section-subtitle">Overall generate dataset session statistics</p>
                    </div>
                </div>
                <div class="stats-grid" id="summary-stats">
                    <div class="stat-card info">
                        <div class="stat-label">Total Sources Available</div>
                        <div class="stat-value" id="stat-total-sources">0</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">Successful</div>
                        <div class="stat-value" id="stat-successful">0</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">Failed</div>
                        <div class="stat-value" id="stat-failed">0</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">Skipped (Too Large)</div>
                        <div class="stat-value" id="stat-skipped">0</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-label">Total CVEs Processed</div>
                        <div class="stat-value" id="stat-total-cves">0</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">Total Warnings</div>
                        <div class="stat-value" id="stat-total-warnings">0</div>
                    </div>
                </div>
            </div>

            <!-- Dataset Runs Table -->
            <div class="section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Completed Dataset Runs</h2>
                        <p class="section-subtitle">Per-source processing details</p>
                    </div>
                </div>
                <div id="dataset-runs-container">
                    <div class="no-data">No dataset runs completed yet</div>
                </div>
            </div>

            <!-- Source Details Table -->
            <div class="section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Source Processing Issues</h2>
                        <p class="section-subtitle">Failed, skipped, and interrupted sources</p>
                    </div>
                </div>
                <div id="sources-container">
                    <div class="no-data">No issues to report</div>
                </div>
            </div>
        </div>

        <div class="footer">
            Generated by Analysis_Tools {{TOOL_VERSION}} â€¢ {{GENERATION_TIME}}
        </div>
    </div>

    <script>
        // Data will be injected here - replaced during HTML generation
        let datasetData = null;

        // Render the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            renderDashboard(datasetData);
        });

        function renderDashboard(data) {
            // Session Information
            document.getElementById('run-id').textContent = data.run_id || 'Unknown';
            document.getElementById('session-start').textContent = formatDateTime(data.session_start);
            document.getElementById('session-end').textContent = formatDateTime(data.session_end);
            document.getElementById('session-duration').textContent = data.duration || 'Unknown';
            document.getElementById('session-status').textContent = data.status || 'In Progress';

            // Summary Statistics
            document.getElementById('stat-total-sources').textContent = data.total_sources || 0;
            document.getElementById('stat-successful').textContent = data.successful || 0;
            document.getElementById('stat-failed').textContent = data.failed || 0;
            document.getElementById('stat-skipped').textContent = data.skipped || 0;
            document.getElementById('stat-total-cves').textContent = data.total_cves_processed || 0;
            document.getElementById('stat-total-warnings').textContent = data.total_warnings || 0;

            // Dataset Runs Table
            renderDatasetRuns(data.dataset_runs || []);
            
            // Source Issues Table (only failed/skipped/interrupted)
            renderSourceTable(data.sources || []);
        }

        function renderDatasetRuns(runs) {
            const container = document.getElementById('dataset-runs-container');
            
            if (!runs || runs.length === 0) {
                container.innerHTML = '<div class="no-data">No dataset runs completed yet</div>';
                return;
            }

            let tableHTML = `
                <table class="source-table">
                    <thead>
                        <tr>
                            <th>Source</th>
                            <th>Total CVEs</th>
                            <th>Processed</th>
                            <th>Warnings</th>
                            <th>Errors</th>
                            <th>Status</th>
                            <th>Runtime</th>
                            <th>Report</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            runs.forEach(run => {
                const statusClass = run.status === 'completed' ? 'status-success' : 'status-badge';
                
                // Construct relative path to dataset report (same directory as index)
                const reportFilename = run.report_filename || `${run.dataset_dir}_report.html`;
                const reportPath = reportFilename;
                const reportLink = reportPath ? 
                    `<a href="${reportPath}" class="report-link" title="View detailed dataset report">View Report</a>` : 
                    '<span style="color: #95a5a6;">N/A</span>';
                
                tableHTML += `
                    <tr>
                        <td><strong>${escapeHtml(run.source)}</strong></td>
                        <td>${run.total_cves}</td>
                        <td>${run.processed_cves}</td>
                        <td>${run.warnings}</td>
                        <td>${run.errors}</td>
                        <td><span class="status-badge ${statusClass}">${run.status}</span></td>
                        <td>${run.runtime}</td>
                        <td>${reportLink}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        function renderSourceTable(sources) {
            const container = document.getElementById('sources-container');
            
            // Only show sources with issues (not success status)
            const problemSources = sources.filter(s => s.status !== 'success');
            
            if (!problemSources || problemSources.length === 0) {
                container.innerHTML = '<div class="no-data">No issues to report - all sources processed successfully</div>';
                return;
            }

            let tableHTML = `
                <table class="source-table">
                    <thead>
                        <tr>
                            <th>Source Name</th>
                            <th>UUID</th>
                            <th>CVE Count</th>
                            <th>Status</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            problemSources.forEach(source => {
                const statusClass = getStatusClass(source.status);
                const statusText = source.status || 'Unknown';
                const cveInfo = source.cve_info || 'N/A';
                const details = source.details || '';
                
                tableHTML += `
                    <tr>
                        <td><strong>${escapeHtml(source.name)}</strong></td>
                        <td><code>${escapeHtml(source.uuid)}</code></td>
                        <td>${cveInfo}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${escapeHtml(details)}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        function getStatusClass(status) {
            const statusMap = {
                'success': 'status-success',
                'failed': 'status-failed',
                'skipped': 'status-skipped',
                'interrupted': 'status-interrupted',
                'not_processed': 'status-not-processed'
            };
            return statusMap[status] || 'status-badge';
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'Unknown';
            try {
                const date = new Date(dateString);
                return date.toLocaleString();
            } catch (e) {
                return dateString;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
